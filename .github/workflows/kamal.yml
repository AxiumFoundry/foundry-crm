name: Kamal Command

on:
  workflow_dispatch:
    inputs:
      command:
        description: "Kamal command to run (without 'kamal' prefix)"
        required: true
        default: "app details"
        type: string

jobs:
  command:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Read server IP from deploy config
        id: deploy_ip
        run: |
          IP=$(grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' config/deploy.yml | head -n 1 || true)
          if [ -z "$IP" ]; then
            echo "::error::Failed to extract server IP from config/deploy.yml. Ensure the file exists and contains a valid IP address."
            exit 1
          fi
          echo "ip=$IP" >> "$GITHUB_OUTPUT"

      - name: Add server to known hosts
        run: |
          IP="${{ steps.deploy_ip.outputs.ip }}"
          if [ -z "$IP" ]; then
            echo "::error::Server IP is empty; cannot add to known_hosts."
            exit 1
          fi
          if ! ssh-keyscan -T 10 "$IP" >> ~/.ssh/known_hosts 2>/dev/null; then
            echo "::error::Failed to fetch SSH host key for $IP (ssh-keyscan failed or timed out)."
            exit 1
          fi

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version

      - name: Install Kamal
        run: gem install kamal --no-document

      - name: Install Bitwarden Secrets Manager CLI
        run: |
          BWS_VERSION="1.0.0"
          BWS_ZIP="bws-x86_64-unknown-linux-gnu-${BWS_VERSION}.zip"
          curl -sLO "https://github.com/bitwarden/sdk/releases/download/bws-v${BWS_VERSION}/${BWS_ZIP}"
          unzip "${BWS_ZIP}"
          sudo install -m 0755 bws /usr/local/bin/bws

      - name: Run Kamal command
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          KAMAL_REGISTRY_PASSWORD: ${{ secrets.KAMAL_REGISTRY_PASSWORD }}
        run: |
          echo "Running: kamal ${{ inputs.command }}"
          kamal ${{ inputs.command }}
