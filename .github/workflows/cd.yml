name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [ main ]

concurrency:
  group: deploy-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    env:
      DOCKER_BUILDKIT: 1

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 1

      - name: Setup BWS CLI
        uses: ./.github/actions/setup-bws

      - name: Fetch secrets from BWS
        id: bws_secrets
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
        run: |
          BWS_JSON=$(bws secret list --output json)
          BWS_PREFIX="FOUNDRY_CRM"

          DOCKER_USER=$(echo "$BWS_JSON" | jq -r '.[] | select(.key == "DOCKER_REGISTRY_USER") | .value')
          if [ -z "$DOCKER_USER" ]; then
            echo "::error::DOCKER_REGISTRY_USER not found in BWS"
            exit 1
          fi
          echo "DOCKER_REGISTRY_USER=$DOCKER_USER" >> $GITHUB_ENV
          echo "DOCKER_IMAGE=$DOCKER_USER/foundry_crm" >> $GITHUB_ENV

          REGISTRY_PASSWORD=$(echo "$BWS_JSON" | jq -r '.[] | select(.key == "KAMAL_REGISTRY_PASSWORD") | .value')
          if [ -z "$REGISTRY_PASSWORD" ]; then
            echo "::error::KAMAL_REGISTRY_PASSWORD not found in BWS"
            exit 1
          fi
          echo "::add-mask::$REGISTRY_PASSWORD"
          echo "registry_password=$REGISTRY_PASSWORD" >> $GITHUB_OUTPUT

          BREVO_SMTP_USERNAME=$(echo "$BWS_JSON" | jq -r '.[] | select(.key == "BREVO_SMTP_USERNAME") | .value')
          if [ -z "$BREVO_SMTP_USERNAME" ]; then
            echo "::error::BREVO_SMTP_USERNAME not found in BWS"
            exit 1
          fi
          echo "brevo_smtp_username=$BREVO_SMTP_USERNAME" >> $GITHUB_OUTPUT

          DEPLOY_NOTIFICATION_EMAIL=$(echo "$BWS_JSON" | jq -r '.[] | select(.key == "DEPLOY_NOTIFICATION_EMAIL") | .value')
          if [ -z "$DEPLOY_NOTIFICATION_EMAIL" ]; then
            echo "::error::DEPLOY_NOTIFICATION_EMAIL not found in BWS"
            exit 1
          fi
          echo "deploy_notification_email=$DEPLOY_NOTIFICATION_EMAIL" >> $GITHUB_OUTPUT

          BREVO_SMTP_KEY=$(echo "$BWS_JSON" | jq -r ".[] | select(.key == \"${BWS_PREFIX}_BREVO_SMTP_KEY\") | .value")
          if [ -z "$BREVO_SMTP_KEY" ]; then
            echo "::error::${BWS_PREFIX}_BREVO_SMTP_KEY not found in BWS"
            exit 1
          fi
          echo "::add-mask::$BREVO_SMTP_KEY"
          echo "brevo_smtp_key=$BREVO_SMTP_KEY" >> $GITHUB_OUTPUT

          SSH_KEY=$(echo "$BWS_JSON" | jq -r '.[] | select(.key == "SSH_PRIVATE_KEY_HETZNER") | .value')
          if [ -z "$SSH_KEY" ]; then
            echo "::error::SSH_PRIVATE_KEY_HETZNER not found in BWS"
            exit 1
          fi
          echo "::add-mask::$SSH_KEY"
          echo "private_key<<EOF_SSH_KEY" >> $GITHUB_OUTPUT
          echo "$SSH_KEY" >> $GITHUB_OUTPUT
          echo "EOF_SSH_KEY" >> $GITHUB_OUTPUT

      - name: Send deployment started notification
        uses: dawidd6/action-send-mail@v9
        continue-on-error: true
        with:
          server_address: smtp-relay.brevo.com
          server_port: 587
          username: ${{ steps.bws_secrets.outputs.brevo_smtp_username }}
          password: ${{ steps.bws_secrets.outputs.brevo_smtp_key }}
          subject: "[${{ github.event.repository.name }}] Deployment started to production"
          to: ${{ steps.bws_secrets.outputs.deploy_notification_email }}
          from: Foundry CRM Deployments <notifications@exampleurl.com>
          body: |
            Deployment STARTED for ${{ github.event.repository.name }}

            Environment: production
            Branch: ${{ github.event.workflow_run.head_branch }}
            Commit: ${{ github.event.workflow_run.head_sha }}
            Author: ${{ github.event.workflow_run.actor.login }}

            All CI checks passed:
            - Security scan (Brakeman / bundler-audit / importmap audit)
            - RuboCop linting
            - Test suite
            - System tests

            View progress: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_REGISTRY_USER }}
          password: ${{ steps.bws_secrets.outputs.registry_password }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.event.workflow_run.head_sha }}
          cache-from: type=gha,scope=foundry_crm-production
          cache-to: type=gha,mode=max,scope=foundry_crm-production
          build-args: |
            RAILS_ENV=production

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ steps.bws_secrets.outputs.private_key }}

      - name: Read server IP from deploy config
        id: deploy_ip
        run: |
          IP=$(grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' config/deploy.yml | head -n 1 || true)
          if [ -z "$IP" ]; then
            echo "::error::Failed to extract server IP from config/deploy.yml. Ensure the file exists and contains a valid IP address."
            exit 1
          fi
          echo "ip=$IP" >> "$GITHUB_OUTPUT"

      - name: Add server to known hosts
        run: |
          IP="${{ steps.deploy_ip.outputs.ip }}"
          if [ -z "$IP" ]; then
            echo "::error::Server IP is empty; cannot add to known_hosts."
            exit 1
          fi
          if ! ssh-keyscan -T 10 "$IP" >> ~/.ssh/known_hosts 2>/dev/null; then
            echo "::error::Failed to fetch SSH host key for $IP (ssh-keyscan failed or timed out)."
            exit 1
          fi

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version

      - name: Install Kamal
        run: gem install kamal --no-document

      - name: Deploy
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          KAMAL_REGISTRY_PASSWORD: ${{ steps.bws_secrets.outputs.registry_password }}
        run: kamal deploy

      - name: Send deployment succeeded notification
        uses: dawidd6/action-send-mail@v9
        continue-on-error: true
        with:
          server_address: smtp-relay.brevo.com
          server_port: 587
          username: ${{ steps.bws_secrets.outputs.brevo_smtp_username }}
          password: ${{ steps.bws_secrets.outputs.brevo_smtp_key }}
          subject: "[${{ github.event.repository.name }}] Deployment succeeded to production"
          to: ${{ steps.bws_secrets.outputs.deploy_notification_email }}
          from: Foundry CRM Deployments <notifications@exampleurl.com>
          body: |
            Deployment SUCCEEDED for ${{ github.event.repository.name }}

            Environment: production
            Branch: ${{ github.event.workflow_run.head_branch }}
            Commit: ${{ github.event.workflow_run.head_sha }}
            Author: ${{ github.event.workflow_run.actor.login }}

            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  notify_deploy_failed:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 1
          sparse-checkout: .github/actions

      - name: Setup BWS CLI
        uses: ./.github/actions/setup-bws

      - name: Fetch secrets from BWS
        id: bws_secrets
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
        run: |
          BWS_JSON=$(bws secret list --output json)
          BWS_PREFIX="FOUNDRY_CRM"

          BREVO_SMTP_USERNAME=$(echo "$BWS_JSON" | jq -r '.[] | select(.key == "BREVO_SMTP_USERNAME") | .value')
          if [ -z "$BREVO_SMTP_USERNAME" ]; then
            echo "::error::BREVO_SMTP_USERNAME not found in BWS"
            exit 1
          fi
          echo "brevo_smtp_username=$BREVO_SMTP_USERNAME" >> $GITHUB_OUTPUT

          DEPLOY_NOTIFICATION_EMAIL=$(echo "$BWS_JSON" | jq -r '.[] | select(.key == "DEPLOY_NOTIFICATION_EMAIL") | .value')
          if [ -z "$DEPLOY_NOTIFICATION_EMAIL" ]; then
            echo "::error::DEPLOY_NOTIFICATION_EMAIL not found in BWS"
            exit 1
          fi
          echo "deploy_notification_email=$DEPLOY_NOTIFICATION_EMAIL" >> $GITHUB_OUTPUT

          BREVO_SMTP_KEY=$(echo "$BWS_JSON" | jq -r ".[] | select(.key == \"${BWS_PREFIX}_BREVO_SMTP_KEY\") | .value")
          if [ -z "$BREVO_SMTP_KEY" ]; then
            echo "::error::${BWS_PREFIX}_BREVO_SMTP_KEY not found in BWS"
            exit 1
          fi
          echo "::add-mask::$BREVO_SMTP_KEY"
          echo "brevo_smtp_key=$BREVO_SMTP_KEY" >> $GITHUB_OUTPUT

      - name: Send deployment failed notification
        uses: dawidd6/action-send-mail@v9
        continue-on-error: true
        with:
          server_address: smtp-relay.brevo.com
          server_port: 587
          username: ${{ steps.bws_secrets.outputs.brevo_smtp_username }}
          password: ${{ steps.bws_secrets.outputs.brevo_smtp_key }}
          subject: "[${{ github.event.repository.name }}] Deployment FAILED to production"
          to: ${{ steps.bws_secrets.outputs.deploy_notification_email }}
          from: Foundry CRM Deployments <notifications@exampleurl.com>
          body: |
            Deployment FAILED for ${{ github.event.repository.name }}

            Environment: production
            Branch: ${{ github.event.workflow_run.head_branch }}
            Commit: ${{ github.event.workflow_run.head_sha }}
            Author: ${{ github.event.workflow_run.actor.login }}

            The deployment process encountered an error.

            View logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            Please check the logs above for details on what failed.
